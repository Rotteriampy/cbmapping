{% extends "base.html" %}
{% block title %}–ú–∞—Ç–µ—Ä–∏–∞–ª—ã{% endblock %}

{% block content %}
<div class="materials-page">
    <div class="page-header">
        <h2>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h2>
    </div>

    <div class="controls">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
        
        <div class="tags-filter">
            <span>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</span>
            <div id="tagsContainer">
                {% for tag in tags %}
                {% if tag != '–í—Å–µ' %}
                <div class="tag-item">
                    <input type="checkbox" id="tag-{{ loop.index }}" value="{{ tag }}">
                    <label for="tag-{{ loop.index }}" class="tag-label">{{ tag }}</label>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="materials-grid" id="materialsGrid">
        {% for mat in materials %}
        <div class="material-card clickable-card" 
             data-title="{{ mat.title|lower }}" 
             data-tag="{{ mat.tag|lower }}"
             data-src="{{ mat.preview_url }}">
            <img src="{{ mat.preview_url }}" alt="{{ mat.title }}" class="material-preview">
            <div class="material-info">
                <h2 class="material-title">{{ mat.title }}</h2>
                <div class="material-tag-single">{{ mat.tag }}</div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="noResults" class="no-results">
        <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫ –∏–ª–∏ —Å–Ω—è—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</p>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
<div id="imageModal" class="modal">
    <span class="close-btn">&times;</span>
    <img id="modalImage" class="modal-content" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
    <div id="modalCaption"></div>
</div>

<script>
    const searchInput = document.getElementById('searchInput');
    const tagsContainer = document.getElementById('tagsContainer');
    const materialsGrid = document.getElementById('materialsGrid');
    const noResults = document.getElementById('noResults');
    const materialCards = Array.from(document.querySelectorAll('.material-card'));

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const captionText = document.getElementById('modalCaption');
    const closeBtn = document.querySelector('.close-btn');

    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    materialsGrid.addEventListener('click', (e) => {
        const card = e.target.closest('.clickable-card');
        if (card && card.dataset.src) {
            modal.style.display = "block";
            modalImg.src = card.dataset.src;
            captionText.textContent = card.querySelector('.material-title').textContent;
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
    closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = (e) => {
        if (e.target === modal) modal.style.display = "none";
    };

    function getActiveTags() {
        return Array.from(tagsContainer.querySelectorAll('input:checked'))
            .map(inp => inp.value.toLowerCase());
    }

    function filterMaterials() {
        const searchTerm = searchInput.value.toLowerCase();
        const activeTags = getActiveTags();

        let hasVisible = false;

        materialCards.forEach(card => {
            const title = card.dataset.title || '';
            const tag = card.dataset.tag || '';

            const matchesSearch = title.includes(searchTerm);
            const matchesTags = activeTags.length === 0 || activeTags.includes(tag);

            if (matchesSearch && matchesTags) {
                card.style.display = '';
                hasVisible = true;
            } else {
                card.style.display = 'none';
            }
        });

        noResults.style.display = hasVisible ? 'none' : 'block';
    }

    searchInput.addEventListener('input', filterMaterials);
    tagsContainer.addEventListener('change', filterMaterials);

    filterMaterials();
</script>
{% endblock %}