{% extends "base.html" %}
{% block title %}MapStats ‚Äî –°–µ—Ä–≤–µ—Ä–∞{% endblock %}

{% block content %}
<div class="servers-page">
    <div class="page-header">
        <h2>Map Stats</h2>
    </div>

    <div class="search-filter">
        <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
        <select id="sortSelect" class="filter-select">
            <option value="name">–ü–æ –∏–º–µ–Ω–∏</option>
            <option value="members">–ü–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º</option>
            <option value="online">–ü–æ –æ–Ω–ª–∞–π–Ω</option>
            <option value="boosts">–ü–æ –±—É—Å—Ç–∞–º</option>
        </select>
    </div>

    <div class="servers-grid" id="serversGrid">
        {% for guild_id, data in servers %}
        {% set info = data.info %}
        {% set icon_url = info.icon_url %}
        {% set premium_count = info.premium_subscription_count|default(0) %}
        <div class="server-card clickable-card"
            data-name="{{ info.name|lower|default('unknown') }}"
            data-members="{{ info.member_count|default(0) }}"
            data-online="{{ info.online_count|default(0) }}"
            data-boosts="{{ premium_count }}"
            onclick="window.location.href='/server/{{ guild_id }}'">
            
            {% if icon_url %}
            <img src="/servers/{{ icon_url }}" alt="Icon" class="server-icon">
            {% endif %}
            
            <div class="server-info">
                <h2 class="server-name">{{ info.name|default('Unknown')|safe }}</h2>
                
                <div class="server-stats">
                    <div class="stat">
                        <div class="stat-number">{{ info.member_count|default(0) }}</div>
                        <div class="stat-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">{{ info.online_count|default(0) }}</div>
                        <div class="stat-label">–û–Ω–ª–∞–π–Ω</div>
                    </div>
                    {% if premium_count > 0 %}
                    <div class="stat">
                        <div class="stat-number">üöÄ {{ premium_count }}</div>
                        <div class="stat-label">–ë—É—Å—Ç–æ–≤</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="noResults" class="no-results">
        <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É</p>
    </div>
</div>

<script>
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const serversGrid = document.getElementById('serversGrid');
    const noResults = document.getElementById('noResults');
    const serverCards = Array.from(document.querySelectorAll('.server-card'));

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlightText(text, query) {
        if (!query.trim()) return text;
        const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    }

    function filterAndSort() {
        const searchTerm = searchInput.value.trim();
        const sortBy = sortSelect.value;

        let filtered = serverCards.filter(card => {
            const name = card.querySelector('.server-name').textContent || '';
            const id = card.getAttribute('onclick').match(/\/server\/(\d+)/)?.[1] || '';

            // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ò–õ–ò –ø–æ ID
            return name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                   id.includes(searchTerm);
        });

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        filtered.sort((a, b) => {
            const aName = a.querySelector('.server-name').textContent.toLowerCase();
            const bName = b.querySelector('.server-name').textContent.toLowerCase();
            const aMembers = parseInt(a.dataset.members) || 0;
            const bMembers = parseInt(b.dataset.members) || 0;
            const aOnline = parseInt(a.dataset.online) || 0;
            const bOnline = parseInt(b.dataset.online) || 0;
            const aBoosts = parseInt(a.dataset.boosts) || 0;
            const bBoosts = parseInt(b.dataset.boosts) || 0;

            if (sortBy === 'name') return aName.localeCompare(bName);
            if (sortBy === 'members') return bMembers - aMembers;
            if (sortBy === 'online') return bOnline - aOnline;
            if (sortBy === 'boosts') return bBoosts - aBoosts;
            return 0;
        });

        // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
        serversGrid.innerHTML = '';
        if (filtered.length === 0) {
            serversGrid.style.display = 'none';
            noResults.style.display = 'block';
        } else {
            serversGrid.style.display = 'grid';
            noResults.style.display = 'none';

            filtered.forEach(card => {
                // –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫—É, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç
                const clone = card.cloneNode(true);
                const nameEl = clone.querySelector('.server-name');
                nameEl.innerHTML = highlightText(nameEl.textContent, searchTerm);
                serversGrid.appendChild(clone);
            });
        }
    }

    // –°–æ–±—ã—Ç–∏—è
    searchInput.addEventListener('input', filterAndSort);
    sortSelect.addEventListener('change', filterAndSort);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    filterAndSort();
</script>
{% endblock %}